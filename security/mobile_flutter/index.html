<!doctype html><html lang=en-us><head><link rel=stylesheet href=/styles.css><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Intercepting Traffic in Mobile Flutter Applications | Alberto Giust</title>
<link rel=canonical href=https://alright21.github.io/security/mobile_flutter/><meta name=description content="Hi, I am Alberto Giust, aka `alright(21)?`, penetration tester at Spike Reply and security enthusiast. In this website you will find CTF writeups and other interesting things I want to document about my journey through the magical world of Cybersecurity."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="Intercepting Traffic in Mobile Flutter Applications"><meta property="og:description" content="Intercepting Traffic in Mobile Flutter Applications During our tests, it may happen that we have to find vulnerabilities in applications built with the Flutter framework. It is pretty common when we have both Android and iOS apps. This framework raises some problems when we need to intercept traffic for two reasons:
flutter apps are proxy unaware - if we add a proxy listener from the settings of our phone, the application will ignore it flutter apps often implement ssl pinning techniques that are not easily bypassed using standard frida scripts Below are explained the solutions for Android and iOS."><meta property="og:type" content="article"><meta property="og:url" content="https://alright21.github.io/security/mobile_flutter/"><meta property="article:section" content="security"><meta property="article:published_time" content="2023-08-01T08:50:38+02:00"><meta property="article:modified_time" content="2023-08-01T08:50:38+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Intercepting Traffic in Mobile Flutter Applications"><meta name=twitter:description content="Intercepting Traffic in Mobile Flutter Applications During our tests, it may happen that we have to find vulnerabilities in applications built with the Flutter framework. It is pretty common when we have both Android and iOS apps. This framework raises some problems when we need to intercept traffic for two reasons:
flutter apps are proxy unaware - if we add a proxy listener from the settings of our phone, the application will ignore it flutter apps often implement ssl pinning techniques that are not easily bypassed using standard frida scripts Below are explained the solutions for Android and iOS."><link rel=stylesheet href=https://alright21.github.io/css/styles.e282735e308195f4ba7bde9c23d7b770c438e682fdb8dd70ed9a1cc443b0ba4ce94a817547eb664fefe53bc615142aa923a0f8f94bb58b5f2441d213e6d7d0a9.css integrity="sha512-4oJzXjCBlfS6e96cI9e3cMQ45oL9uN1w7ZocxEOwukzpSoF1R+tmT+/lO8YVFCqpI6D4+Uu1i18kQdIT5tfQqQ=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://alright21.github.io/favicon.ico><div id=cookie-notice><span>We would like to use third party cookies and scripts to improve the
functionality of this website.</span>
<a id=cookie-notice-accept class="btn btn-primary btn-sm">Approve</a>
<a id=cookie-notice-deny class="btn btn-primary btn-sm">Deny</a>
<a href=/privacy id=cookie-notice-privacy class="btn btn-primary btn-sm">More info</a><br><span id=cookie-credits>Credits to this banner: <a id=cookie-notice-privacy href=https://github.com/Kudos01>Kudos01</a></div></div><script>function createCookie(e,t,n){var s,o="";n&&(s=new Date,s.setTime(s.getTime()+n*24*60*60*1e3),o="; expires="+s.toUTCString()),document.cookie=e+"="+t+o+"; path=/"}function readCookie(e){for(var t,s=e+"=",o=document.cookie.split(";"),n=0;n<o.length;n++){for(t=o[n];t.charAt(0)==" ";)t=t.substring(1,t.length);if(t.indexOf(s)==0)return t.substring(s.length,t.length)}return null}function eraseCookie(e){createCookie(e,"",-1)}if(readCookie("cookie-notice-option")=="true"){function loadScriptAsync(e,t){if(typeof t!="function")throw new Error("Not a valid callback for async script load");var n=document.createElement("script");n.onload=t,n.src=e,document.head.appendChild(n)}loadScriptAsync("https://www.googletagmanager.com/gtag/js?id=G-7KVTDGPL67",function(){window.dataLayer=window.dataLayer||[];function e(){dataLayer.push(arguments)}e("js",new Date),e("config","G-7KVTDGPL67",{anonymize_ip:!0})})}else readCookie("cookie-notice-option")!="false"&&(document.getElementById("cookie-notice").style.display="block");document.getElementById("cookie-notice-accept").addEventListener("click",function(){createCookie("cookie-notice-option","true",31),document.getElementById("cookie-notice").style.display="none",location.reload()}),document.getElementById("cookie-notice-deny").addEventListener("click",function(){createCookie("cookie-notice-option","false",31),document.getElementById("cookie-notice").style.display="none",location.reload()})</script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://alright21.github.io/><div id=logo style=background-image:url(https://alright21.github.io/images/logo.png)></div><div id=title><h1>Alberto Giust</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/security>Security</a></li><li><a href=/ctf>CTFs</a></li><li><a href=/education>Education</a></li><li><a href=/dev>Dev</a></li><li><a href=/about>About</a></li></ul></div></header><article class=post itemscope itemtype=http://schema.org/BlogPosting><div class=content itemprop=articleBody><h1 id=intercepting-traffic-in-mobile-flutter-applications>Intercepting Traffic in Mobile Flutter Applications</h1><p>During our tests, it may happen that we have to find vulnerabilities in applications built with the Flutter framework. It is pretty common when we have both Android and iOS apps. This framework raises some problems when we need to intercept traffic for two reasons:</p><ol><li>flutter apps are proxy unaware - if we add a proxy listener from the settings of our phone, the application will ignore it</li><li>flutter apps often implement ssl pinning techniques that are not easily bypassed using standard frida scripts</li></ol><p>Below are explained the solutions for Android and iOS. For iOS, I will explain the procedure
that the researchers from <a href=https://www.nviso.eu/>nviso</a> suggest in their articles (Android[1] and iOS[2]) and article. They have full credit over this, I will add some comments on what was not immediately clear to me:)</p><h2 id=android>Android</h2><p>The general solution for Android applications is to tinker with <code>iptables</code>. As a result, all the traffic will be forwarded based on the rules we set. If we add a forwarding rule to our proxy, it&rsquo;s game over :) But, how can we do it? The solution we found is ProxyDroid!</p><p>ProxyDroid is an Android application that requires root privileges and modifies the IP routes in order to forward all the traffic to our desired IP address.</p><p>We can download Proxydroid from the Play Store. Remember that we need to have a rooted device to be able to run it.</p><p>Here is the complete procedure to set up our proxying rules:</p><ol><li>download the application from the Play Store (<code>org.proxydroid</code>) and install it</li><li>open the application and modify the parameters as shown in the Figure below. Add your laptop/PC IP address, and an available port (e.g. <code>8087</code>), and set the Proxy type to HTTP</li></ol><figure><img src=/assets/android_proxydroid.png alt="ProxyDroid setup" style=width:60%><figcaption>ProxyDroid setup</figcaption></figure><ol start=3><li>Now the application traffic is sent to our proxy server since the Flutter library cannot ignore these route changes. If the application does not implement SSL pinning, our job is done (skip the other steps). However, it is not often the case</li><li>Frida to the rescue! We can use this tool to bypass SSL pinning. We can download the script below, and spawn the application with <code>frida -U -f com.package.name -l script_name.js</code><ul><li><a href=https://raw.githubusercontent.com/NVISOsecurity/disable-flutter-tls-verification/main/disable-flutter-tls.js>https://raw.githubusercontent.com/NVISOsecurity/disable-flutter-tls-verification/main/disable-flutter-tls.js</a></li></ul></li><li>Now we should be able to intercept all the traffic or your Flutter application:)</li></ol><h2 id=ios>iOS</h2><p>In iOS devices, we don&rsquo;t have any"ProxyDroid" like applications, so we need to find a different solution. As written in the article cited above, we can set up a wifi hotspot network or use OpenVPN to tunnel all the traffic through our proxy. I will explain the second solution since it is the only one I tried and worked for me (and it is probably the easiest one).</p><p>Here are the steps required to set up the VPN and start intercepting the traffic</p><ol><li>install the OpenVPN client on your iOS device (from the App Store)</li><li>download in your PC the script below, and set it up to be executable (from a Linux terminal)</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># download</span>
</span></span><span style=display:flex><span>wget https://git.io/vpn -O openvpn-install.sh
</span></span><span style=display:flex><span><span style=color:#75715e># removes line that makes script crash in Kali</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(($(</span>grep -ni <span style=color:#e6db74>&#34;debian is too old&#34;</span> openvpn-install.sh | cut  -d : -f 1<span style=color:#66d9ef>)</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span><span style=color:#66d9ef>))</span><span style=color:#e6db74>d&#34;</span> ./openvpn-install.sh
</span></span><span style=display:flex><span><span style=color:#75715e># make the script executable</span>
</span></span><span style=display:flex><span>chmod +x ./openvpn-install.sh
</span></span><span style=display:flex><span><span style=color:#75715e># execute the script</span>
</span></span><span style=display:flex><span>sudo ./openvpn-install.sh
</span></span></code></pre></div><ol><li>follow the guided steps and insert your PC private IP (re-enter when they ask you to enter the public one). Keep <code>UDP</code>, <code>1194</code> port, and probably default DNS is fine. Finally, add a name (it will create a file with that name inside <code>/root/</code> directory)</li></ol><pre tabindex=0><code>Welcome to this OpenVPN road warrior installer!

Which IPv4 address should be used?
     1) 192.168.1.4
     2) 192.168.122.1
     3) 172.17.0.1
IPv4 address [1]: 1

This server is behind NAT. What is the public IPv4 address or hostname?
Public IPv4 address / hostname [93.66.98.98]: 192.168.1.4

Which protocol should OpenVPN use?
   1) UDP (recommended)
   2) TCP
Protocol [1]: 1

What port should OpenVPN listen to?
Port [1194]: 1194

Select a DNS server for the clients:
   1) Current system resolvers
   2) Google
   3) 1.1.1.1
   4) OpenDNS
   5) Quad9
   6) AdGuard
DNS server [1]: 1

Enter a name for the first client:
Name [client]: client
</code></pre><ol start=4><li>start the VPN service</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo service openvpn start
</span></span></code></pre></div><ol start=5><li>copy the configuration file from <code>/root/&lt;filename>.ovpn</code> to your device. As suggested in the article, you can use a Python server to do that.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo python3 -m http.server <span style=color:#ae81ff>8081</span> --directory /root/
</span></span></code></pre></div><ol start=6><li>download the configuration file into your device, by connecting to http://IP:8081</li><li>load the configuration file into the OpenVPN client. You can do it by going to the file explorer, sharing the file and opening it with the OpenVPN client</li><li>back to your computer: configure your IP tables to forward all the traffic coming from the <code>tun0</code> VPN interface, to your BurpSuite listening port (<code>&lt;BURP_PORT></code>). Also set <code>&lt;IP_SUBNET></code> to your subnet (e.g. <code>192.168.1.0/24</code>, remember the <code>/24</code>)</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># forward HTTP traffic</span>
</span></span><span style=display:flex><span>sudo iptables -t nat -A PREROUTING -i tun0 -p tcp --dport <span style=color:#ae81ff>80</span> -j REDIRECT --to-port &lt;BURP_PORT&gt;
</span></span><span style=display:flex><span><span style=color:#75715e># forward HTTPS traffic</span>
</span></span><span style=display:flex><span>sudo iptables -t nat -A PREROUTING -i tun0 -p tcp --dport <span style=color:#ae81ff>443</span> -j REDIRECT --to-port &lt;BURP_PORT&gt;
</span></span><span style=display:flex><span>sudo iptables -t nat -A POSTROUTING -s &lt;IP_SUBNET&gt; -o eth0 -j MASQUERADE
</span></span></code></pre></div><ol start=9><li>go to Burp Suite and start a proxy listener on your <code>&lt;BURP_PORT></code>, on all the interfaces. Moreover, remember to enable invisible proxying</li></ol><p>The route forwarding rules should be set by now, and we should be able to intercept the traffic of our beloved application. If you do not see any traffic, and the application seems that it is not working, the SSL pinning guards have been probably called for help.</p><p>We can bypass using the same frida script used before (it checks if we are working with Android or iOS) and start it with <code>frida -U -f com.package.name -l script_name.js</code></p><ul><li><a href=https://raw.githubusercontent.com/NVISOsecurity/disable-flutter-tls-verification/main/disable-flutter-tls.js>https://raw.githubusercontent.com/NVISOsecurity/disable-flutter-tls-verification/main/disable-flutter-tls.js</a></li></ul><p><strong>Note</strong>: when you need to reset your configuration (e.g. change the OpenVPN configuration), the only possibility I found is to remove OpenVPN (command <code>4</code>) and reinstall it again. This can mess up your OpenVPN already installed (at least in my Ubuntu machine).</p><p>To fix it, you can reinstall it with <code>sudo apt-get install openvpn network-manager-openvpn network-manager-openvpn-gnome</code></p><p>And that&rsquo;s all! If you have any questions, let me know:)</p><h1 id=references>References</h1><p>[1] <a href=https://blog.nviso.eu/2022/08/18/intercept-flutter-traffic-on-ios-and-android-http-https-dio-pinning/>https://blog.nviso.eu/2022/08/18/intercept-flutter-traffic-on-ios-and-android-http-https-dio-pinning/</a></p><p>[2] <a href=https://blog.nviso.eu/2020/06/12/intercepting-flutter-traffic-on-ios/>https://blog.nviso.eu/2020/06/12/intercepting-flutter-traffic-on-ios/</a></p></div></article><footer id=footer><div class=footer-left>Copyright &copy; 2024 Alberto Giust</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/security>Security</a></li><li><a href=/ctf>CTFs</a></li><li><a href=/education>Education</a></li><li><a href=/dev>Dev</a></li><li><a href=/about>About</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script></html>